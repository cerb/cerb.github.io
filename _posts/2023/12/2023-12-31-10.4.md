---
layout: post
title:  "In Development: 10.4"
excerpt: Cerb 10.4 is a major feature update in development during June 2023 with 68 improvements from community feedback.
author: The Cerb Team
date: 2023-06-17 12:00:00 -0700
permalink: /releases/10.4/
social_image_url: /assets/images/releases/10.4/10.4.png
redirect_from:
  - /10.4/
tags: cerb announcements releases
release:
  type: feature upgrade
  count: 68
---

<div class="cerb-screenshot">
<img src="{{page.social_image_url}}" class="screenshot" width="500">
</div>

**Cerb (10.4)** is a **{{ page.release.type }}** in development as of {{page.date|date:'%B %d, %Y'}}.  It includes more than **{{ page.release.count }}** new features and improvements from community feedback.

* TOC
{:toc}

<div class="cerb-box note">
	<p>
		To check if you qualify for this release as a free update, view <b>Setup &raquo; Configure &raquo; License</b>. If your software updates expire on or after <b>December 31, 2022</b> then you can upgrade without renewing your license.  Cerb Cloud subscribers will be upgraded automatically.
	</p>
</div>

{% comment %}
# Introduction
...

Thanks for supporting Cerb!

- Jeff Standen, Software Architect, Cerb
{% endcomment %}

# Important Release Notes

* [**Always make a backup before upgrading!**](/docs/backups/)

* **Cerb 10.4** requires **PHP 8.1+** and **MySQL 5.7+** (or **MariaDB 10.3+**).

* To upgrade your installation, [follow these instructions](/docs/upgrading/).

* **NOTE:** The [branches](https://github.com/cerb/cerb-release/branches) in the `cerb/cerb-release` repository have changed. The `master` branch has been removed, and new branches exist for each major version (e.g. `v10.3`, `v10.4`).

* Visit the [community forums](https://github.com/cerb/cerb-release/discussions/) for tutorials and guides on new 10.x features.

# Changelog

## Added

* **[Developers/Docker/Compose]** Added a Docker Compose configuration to `./install/docker/`. This dramatically simplifies development, testing, and evaluation by spinning up local pre-configured containers for Nginx, PHP-FPM, and MySQL with a single `docker compose up` command. The directory also includes an annotated example of using config overrides like `docker compose up -f docker-compose.yml -f overrides/example.yml up` to manage multiple environments. Changes to the local Cerb files are instantly reflected in the deployed containers. These files should not be used in production, but can be used as a reference for doing so with Docker.

* **[Automations/Events/Listeners]** Automation Event Listener records now conditionally bind automations to events using KATA. Previously this was done directly on the event record, which frequently caused conflicts when merging events from packages, workflows, etc. A listener is a group of related bindings. The priority of a listener determines when it is evaluated compared to other listeners. When managed by a workflow, a listener can't be modified directly in order to provide consistency. Listeners can be disabled as a set without having to comment out Event KATA. The existing KATA for each event has been moved to a new listener named 'Default'.

* **[Toolbars/Worklists]** Added a customizable `records.worklist` toolbar that displays beneath every worklist in the UI. Toolbar items may be added based on the worklist ID, record type, query, or current worker. Interactions receive caller parameters for `worklist_id`, `worklist_record_type`, and `selected_record_ids`. An `after:refresh_worklist@bool:` option determines if the worklist refreshes after the interaction (default `yes`).

* **[Automations/Visualization]** In the automation editor popup, the 'Visualization' tab now shows a proper 'directed acyclic graph' (DAG) for the possible execution paths of the automation. The graph supports panning and zooming with the mouse. Clicking on a node automatically scrolls to the relevant line in the code editor.

* **[Automations/Editor]** The automation editor now gives autocompletion suggestions for `@annotations` in KATA code. Multiple automations can be chained together with commas. [[#1611](https://github.com/jstanden/cerb/issues/1611)]

* **[Chart KATA]** When editing 'Chart KATA' widgets, the tick formatters for `date:` and `number:` patterns now have an interactive helper. Previously, this required manually entering formatting strings like `%Y-%m-%d %H:%M:%S` or `.4f`.

* **[Sheets]** Sheet KATA may define optional column parameters for `color:` and `text_color:`. When used with the `@raw` annotation, the value may contain scripting and row placeholders. The value should be the key of a color set defined in `layout:colors:` as a list of HEX color codes (e.g. `#ffcc00`). The value may contain a `:n` suffix, where `n` is the 0-based index from the color set. This can be done dynamically for threshold colors. By default, the first color is used. If a color set contains a `_dark` suffix, it will be used automatically in dark mode (e.g. `rainbow12` will check for the existence of `rainbow12_dark`). Entire rows can be colorized by using the same `color:` parameter on all columns. [[#1111](https://github.com/jstanden/cerb/issues/1111)]

* **[Sheets]** Sheet KATA may define an optional column parameter for `text_size:`. This is a numeric percentage of the current text size (e.g. `text_size: 150`). This is particularly useful with `layout:style: fieldsets` when rendering cards.

* **[Toolbars]** In Toolbar KATA, a new `class:` option allows CSS classes to be added to toolbar items. This allows functionality that renders a toolbar to provide extra functionality. For instance, hiding toolbar buttons unless at least one sheet row is selected.

* **[Toolbars/Comments]** Added a `comment.editor` toolbar to display interactions above the editor when writing comments. This receives caller parameters for `record_id`, `record_type`, and `selected_text`. For instance, a translation service can be used to translate selected text and paste it into the comment editor. Thanks to [1Password](https://1password.com/) for the feature request!

* **[Interactions/Worker]** Added a reusable `cerb.ticket.status` worker interaction for changing the status of a ticket. This is used on ticket profiles in the 'Status' widget. The `inputs:record/ticket:` and `inputs:text/status:` are required. An optional `inputs:text/confirm:` displays a confirmation message before proceeding (e.g. closing, deletion).

* **[Interactions/Worker]** Added a reusable `cerb.ticket.assign` worker interaction for changing the owner of a ticket. This is used on ticket profiles in the 'Owner' widget.

* **[Cards/Sheets]** On 'Sheet' card widgets, implemented the `grid` and `columns` layouts.

* **[Profiles/Sheets]** On 'Sheet' profile widgets, implemented the `grid` and `columns` layouts.

* **[Workspaces/Sheets]** On 'Sheet' workspace widgets, implemented the `grid` and `columns` layouts.

* **[Automations/Records]** In automations, the `record.get:` command may now provide the `record_expand:` option for additional keys to expand. This makes it consistent with other commands like `record.search:`.

* **[Profiles/Widgets]** On profile tabs, widgets may now be shown or hidden using conditional logic. For instance, a widget may only be visible when tickets are within a certain group, or lack a custom field value. When at least one widget is hidden, admins will see a 'Toggle Hidden' button at the top of a profile tab. This allows hidden widgets to still be rendered or edited.

* **[Profiles/Dashboards/UX]** On profile tabs, admins have a new 'Edit Tab' shortcut button in the top toolbar. This saves several clicks when renaming a dashboard or changing its layout.

* **[Sheets/Widgets]** On sheet widgets, added the ability to define default `data:` when a data source is empty. For instance, this is useful to display static data (e.g. announcements on a workspace) with the functionality of sheets (paging, formatting).

* **[Profiles/Sheets]** On 'Sheet' profile widgets, custom `keyboard:` shortcuts can be configured for toolbar interactions.

* **[Cards/Toolbars]** On `record.card` toolbars, added a new `after:refresh_toolbar@bool:` option to refresh the toolbar after an interaction finishes. For instance, if an interaction changes the status of a record and toolbar items are conditional on status. [[#1726](https://github.com/jstanden/cerb/issues/1726)]

* **[Profiles/Toolbars]** On `record.profile` toolbars, added a new `after:refresh_toolbar@bool:` option to refresh the toolbar after an interaction finishes. [[#1726](https://github.com/jstanden/cerb/issues/1726)]

* **[Setup/Developers]** In the Setup->Developers menu, added a new 'Platform' page. This allows developers to clear the server-side cache with a single click. It also provides the ability to reload/synchronize built-in assets from disk: automations, package library, and resources. [[#1683](https://github.com/jstanden/cerb/issues/1683)]

* **[Records/Tickets]** When updating ticket records, a new `bucket:` field may be used with a literal bucket name to match. This improves readability in automations. Previously, only a record ID could be used, like `bucket_id: 123`. When using the new field, either `group:` or `group_id:` must also be provided to disambiguate bucket names like 'Inbox'.

* **[Sheets/Toolbars]** Added a new `toolbar:` column type to sheets. This displays an interactions toolbar for each row. It's particularly useful with `layout:style: fieldsets` to summarize a record with common actions. [[#1467](https://github.com/jstanden/cerb/issues/1467)]

* **[Automations/Events]** Added a new `mail.moved` automation event. This triggers every time a ticket is moved between groups or buckets, including cascading routing like (A->B->C). The event includes placeholders for `ticket_` as well as `was_group_` and `was_bucket_`. This simplifies conditional routing that depends on where a ticket was moved from.

* **[Portals/Interactions]** On third-party websites using an `interaction.website` portal, DOM elements may include an `data-cerb-interaction-style` attribute to configure the interaction method. The possible values are `float` (default; interactions appear in a floating popup window in the bottom left of the browser), `full` (same as `float` but the popup uses the full browser width), and `embed` (the interaction is inline with page content).

* **[Cards/Toolbars]** `record.card` toolbars may now include an `after:refresh_toolbar@bool:` action. This refreshes the toolbar at the top of the profile page in the same manner as `after:refresh_widgets:`.

* **[Profiles/Toolbars]** `record.profile` toolbars may now include an `after:refresh_toolbar@bool:` action. This refreshes the toolbar at the top of the profile page in the same manner as `after:refresh_widgets:`.

* **[Widgets/Sheets]** On sheet widgets (cards, profiles, workspaces), interactions launched from a sheet toolbar now include caller parameters for `rows_selected` and `rows_visible`. If a `selection` column is defined, these parameters respectively are set to the value of the currently selected sheet rows, and the value of all sheet rows displayed on the current page. This removes the need to explicitly pass selected sheet rows to an interaction for these widgets. As well, it makes it possible to act on not only selected sheet rows, but also deselected rows, or an entire page at once (e.g. bulk update). Thanks to [@mryanb](https://github.com/mryanb/) for the feature request!

* **[Automations/Scripting]** In automation scripting, added an `|html_to_text()` filter for converting an HTML document to plaintext. This uses the same functionality that generates a plaintext part for inbound HTML messages.

* **[Custom Records/Subtotals]** In custom record types, implemented the ability to subtotal by record name.

* **[Worklists/Export]** When exporting a worklist in the JSON/JSONL formats, a column `value:` may now be a nested object rather than just a string. This change simplifies exporting data for integrations (e.g. HuggingFace model training).
  
* **[Custom Fields/Markdown]** 'Text: Multiple Lines' custom fields may now be configured to allow Markdown formatting. Markdown formatting options will be displayed in the record editor, along with a rendering preview. The `|markdown_to_html` filter can be used in sheets to show the formatting. [[#1085](https://github.com/jstanden/cerb/issues/1085)]

## Changed

* **[Records/Custom Fields/UX]** In record editors, typing backspace in an empty list-based custom field value removes the text input.

* **[Profiles/Ticket]** On ticket profiles, the 'Actions' custom HTML widget is removed if unmodified. Otherwise, it is prefixed with '(DEPRECATED)'. Custom HTML widgets should be migrated to interaction toolbar widgets. The actions are all now available elsewhere on the profile page.

* **[Profiles/Tickets/Conversation]** On ticket profile pages, the 'Read All' button is now built-in to the 'Conversation' widget. Previously this was implemented in the 'Actions' custom HTML widget. The 'A' shortcut continues to function as before.

* **[Records/Profiles/Merge]** On record profile pages, the 'Merge' button has moved to the top toolbar (if a worker has permission). Previously this was implemented in an 'Actions' custom HTML widget.

* **[Records/Search/Performance]** When searching records, full-text query terms with special characters (e.g. email addresses, URLs, hosts, IPs, phone numbers) are now automatically quoted for phrase matching. This improves match relevance, and also improves performance by using fewer results in joins.

* **[Profiles/Widgets/Sheets]** On ticket and task profiles, the 'Status' widget now uses a fieldsets-based sheet rather than the deprecated 'HTML/Javascript' type. These sheets are much easier to customize with KATA (e.g. card popups, keyboard shortcuts, colors, font sizes).

* **[Profiles/Widgets/Sheets]** On ticket profiles, the 'Owner' widget now uses a fieldsets-based sheet rather than the deprecated 'HTML/Javascript' type. These sheets are much easier to customize with KATA (e.g. card popups, keyboard shortcuts, colors, font sizes).

* **[Automations/Scripting]** In automation scripting, the `is pattern` test now allows a mix of strings and string arrays as parameters. This makes it much easier to use a dynamically generated list of rules (e.g. {% raw %}`{{sender_address is pattern (rules)}}`{% endraw %}).

* **[Sheets/Widgets]** When configuring card, profile, and workspace Sheet widgets, the sheet editor now provides an 'Insert Placeholder' menu.

* **[Toolbars/UX]** When editing Toolbar KATA, the `after:` option now offers extension-specific autocompletion suggestions.
  
* **[Automations/Events/Editor]** The automation event editor now properly suggests `uri:` auto-completions only for the current event. Previously, this suggested any matching automation.

* **[Platform/PHP]** Cerb now requires PHP 8.1 or later.

* **[Records/Performance]** Improved performance when searching `message` records. The results now only return record IDs which can often be served entirely by in-memory indexes. The record fields are loaded per page of results, rather than for the entire set.

* **[Worklists/Search/UX]** In worklists, search queries with syntax errors now clearly display a warning above the list.

* **[Mail/Formatting]** When composing or replying to mail, the formatting toolbar buttons for 'Unordered List' and 'Quote' now insert formatting even when no text is selected. Previously they only worked with an editor text selection.
  
* **[Behaviors/Widgets]** In bot behaviors and widgets, the 'Insert Placeholder' menu now inserts custom field placeholders using their descriptive URI rather than the legacy `custom_123` syntax.

* **[Performance/Custom Fieldsets]** Improved the performance of some database queries involving custom fieldsets.

* **[Cards/Widgets/Sheets]** On 'Sheet' card widgets, toolbar KATA now offers autocompletion suggestions for `interaction:after:`.

* **[Profiles/Widgets/Sheets]** On 'Sheet' profile widgets, toolbar KATA now offers autocompletion suggestions for `interaction:after:`.

* **[Workspaces/Widgets/Sheets]** On 'Sheet' workspace widgets, toolbar KATA now offers autocompletion suggestions for `interaction:after:`.

* **[Interactions/Tickets]** Improved the built-in `cerb.ticket.move` interaction used on ticket profiles. Groups and buckets can now be selected with a single-click and no extra 'Continue' step.

* **[Installer]** The installer will now attempt to initialize an empty `./storage` directory. This simplifies deployment in containers, continuous integration, and testing.

* **[Platform/Dependencies]** Updated the Ace Editor dependency from v1.4.14 to v1.12.5. This is used in code editors and the changeset history diff viewer.

* **[Platform/Dependencies]** Upgraded the jQuery library from 3.6.0 to 3.6.4.

* **[Platform/Dependencies]** Updated `singpolyma/openpgp-php` from 0.5.0 to 0.6.0. This is the library used for sending and receiving PGP encrypted email messages.

* **[Platform/Dependencies]** Updated `tijsverkoyen/css-to-inline-styles` from 2.2.4 to 2.2.6. This resolves an issue with 4-byte emoji in email and comments. It also improves PHP 8.2 support.

* **[Platform/Dependencies]** Updated `phpseclib` from ~2.0 to 3.0.18.

## Deprecated

## Removed

* **[Portals/Support Center]** Removed jQuery from the legacy Support Center portal. It now uses vanilla Javascript.

* **[Installer]** Removed jQuery from the guided installer. It now uses vanilla Javascript.

## Fixed

* **[Mail/Relay]** Fixed an issue with bot behaviors using the 'Relay Email to Workers' action. If a group didn't have a reply-to address assigned then a fatal error could prematurely abort email parsing.

* **[Records/Search]** Fixed an issue when full-text searching records where a term like `a*star` could perform an inadvertent wildcard match for all terms beginning with 'a'. This is now treated as a literal phrase match.

* **[Records/UX]** Fixed an issue on record editor popups where an expired session could misleadingly still report 'Saved!' when the 'Save Changes' button was clicked. This now shows an obvious error.

* **[Platform/Sessions]** Fixed an issue where the initial session cookie wasn't set with `samesite=lax`. The flag was only set when the cookie was refreshed 2.5 minutes later.

* **[Records/Custom Fields/UX]** In record editors, after adding a new value to a list-based custom field, focus is now properly set on the new text input to save the extra click.

## Security

* **[Security/Sessions]** The session cookie now sets an explicit path (e.g. `/helpdesk/`). Previously cookies were always set on the top-level domain. This could cause problems with multiple Cerb instances hosted on the same domain in different paths.

* **[Security/Sessions]** The session cookie has been renamed to `Cerb` from `Devblocks`.
